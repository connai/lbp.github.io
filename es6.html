<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ecmascript 6 | marklbp blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="plugins/fonts/awesome/css/awesome.css">
  <link rel="stylesheet" type="text/css" href="plugins/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="stylesheets/markdown.css">
  <style type="text/css">
  .left-side,
  .right-side{
    width: 100%;
  }
  .left-side,
  .right-side,
  .aside,
  .content{
    position: relative;
    float: left;
  }
  .left-side{
    overflow: hidden;
  }
  .right-side{
    right: 80%;
    box-shadow: 0 0 40px #CCC;
    -webkit-box-shadow: 0 0 40px #CCC;
    -moz-box-shadow: 0 0 40px #CCC;
    border-right: 1px solid #BBB;
  }
  .aside{
    width: 20%;
    left: 80%;
  }
  .content{
    width: 80%;
    left: 80%;
  }
  </style>
</head>
<body>
  <div class="box">
    <div class="left-side">
      <div class="right-side">
        <div class="aside">
          <div class="inner" id="aside_content"></div>
        </div>
        <div class="content">
          <div class="inner" id="main_content"></div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="plugins/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="plugins/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/marklbp.js"></script>
  <script type="text/javascript" src="js/marked.js"></script>
  <script type="text/javascript" src="js/prism.js"></script>
  <script type="text/javascript">
    (function(context){
      return context.extend(context,{
        config: {
          aside: '#aside_content',
          content: '#main_content',
          cache: {},
          cacheKey: 'MARKLBP_ES6_HANDBOOK'
        },
        init: function (){
          return this.updateCache().initEvents().renderContent(this.config.aside, 'es6').updateContent()
        },
        initEvents: function (){
          var that = this
          $(window).on('hashchange', $.proxy(this.updateContent, this))
          $(document).on('click', 'a.section-link', function(e){
            e.preventDefault();
            var hash = this.dataset.hash
            var content = this.dataset.content
            history.pushState(null, null, '#' + hash + '#' + content);
            $('html, body').animate({
              scrollTop: $('#' + content).offset().top
            }, 300);
          }).on("click","a.go-top", function(e){
            e.preventDefault()
            that.goTop()
          }).on("click", "li.link[data-id]", function(e){
              e.preventDefault();
              // scroll to relevant section
              var header = $("h2#" + this.dataset.id);
              $('html, body').animate({
                scrollTop: header.offset().top
              }, 200);

              // highlight the relevant section
              original_color = header.css("color");
              header.animate({ color: "#ED1C24", }, 500, function() {
                // revert back to orig color
                $(this).animate({color: original_color}, 2500);
              });
              history.pushState(null, null, '#' + location.hash.split('#')[1] + '#' + this.dataset.id);
          }).on("mouseover mouseout", this.config.content + " h2," + this.config.content + " h3," + this.config.content + " h4", function (e) {
            if (this.resetTime) clearTimeout(this.resetTime)
            if (e.type === 'mouseover') {
              $(this).find("a").show()
            } else {
              this.resetTime = setTimeout($.proxy(function(){$(this).find("a").hide()}, this), 500);
            }
          })
          return this
        },
        updateContent: function(){
          var file = location.hash.split("#")[1]
          if(!file || file.length <= 0){
            file = 'intro'
          }
          return this.renderContent(this.config.content, file)
        },
        renderContent: function(selector, file){
          if (this.config.cache[file]) {
            $(selector).html(this.config.cache[file])
            return this
          }
          return this.ajax({
            url: (file === 'es6' ? '/javascript/es6/' : '/javascript/es6/docs/') + file + '.md',
            type: 'get',
            done: function(data){
              var str = marked(data)
              var dom = $('<div class="marked-text">' + str + '</div>');
              dom.find("code").map(function(){
                Prism.highlightElement(this)
              })
              if(file !== 'es6'){
                this.createAnchors(dom)
              }
              this.updateCache({key: file, value: dom[0].outerHTML})
              $(selector).html(dom)
            },
            fail: function(data){
              $(selector).html(data.value)
            }
          })
        },
        createAnchors: function(dom){
          var hash = location.hash.split('#')[1]
          hash = hash || 'intro'
          for (var i = 2, lis; i <= 4; i++) {
            if (i === 2) lis = []
            dom.find('h' + i).map(function() {
              var content = $(this).text()
              this.id = content.replace(/, /g, ',').replace(/[&\/\\#,.+=$~%'":*?<>{}\ \]\[]/g, "-").replace(/[()]/g, '')
              this.innerHTML = content +
                ' <a style="display: none" href="#' + hash + '#' + this.id + '" class="section-link" data-content="' + this.id + '" data-hash="' + hash + '">ยง</a> <a href="javascript:void(0)" style="display: none" class="go-top">โง</a>'
              this.setAttribute('data-content', content)
              if(lis){
                lis.push('<li data-id="' + this.id + '" class="link"><a href="#' + hash + '#' + content + '">' + content + '</a></li>')
              }
            })
            if (lis) {
              dom.find(">h1").eq(0).after("<ol id='content-toc'>" + lis.join('') + "</ol>")
              lis = null
            }
          }
          return this
        },
        goTop: function () {
          $('html, body').animate({
            scrollTop: 0
          }, 200);
          history.pushState(null, null, '#' + location.hash.split('#')[1]);
        },
        updateCache: function(opt){
          var storeCache = localStorage.getItem(this.config.cacheKey)
          if(!storeCache){
            localStorage.setItem(this.config.cacheKey, JSON.stringify(this.config.cache))
            storeCache = '{}'
          }
          if(!opt || typeof opt !== 'object')return this
          storeCache = JSON.parse(storeCache)
          storeCache[opt.key] = opt.value || storeCache[opt.key]
          this.config.cache = storeCache
          localStorage.setItem(this.config.cacheKey, JSON.stringify(storeCache))
          return this
        }
      }).init()
    })(Marklbp)
  </script>
</body>
</html>