+function(global,context) {
	$.extend(true,context,{
		options: {
			pay: {
				isNeedPass: true,
				isNeedSMS: false/*,
				couponBalance: 0,
				limitMoney: undefined*/
			}
		},
		// 分转元，保留 n 位小数
		toFixed: function (fen,n) {
			this.toFixed = 'function' == typeof Number.prototype.toFixed ? function(fen,n){
				n = isNaN(parseInt(n)) ? 0 : Math.abs(parseInt(n));
				fen = isNaN(parseFloat(fen)) ? 0 : parseFloat(fen);
				var m = fen/Math.pow(10,n);
				return m.toFixed(n) 
			}: function(fen,n){
				n = isNaN(parseInt(n)) ? 0 : Math.abs(parseInt(n));
				fen = isNaN(parseFloat(fen)) ? 0 : parseFloat(fen);
				var arr = (fen/Math.pow(10,n)+'').split(".");
				var int = Number(arr[0]);
				var decimal = arr[1];
				//保留0位小数
				if(n <= 0)return decimal&&decimal[0] >= 5 ?  int + 1 : int;
				
				//没有小数点
				if(decimal === undefined)return int + '.' + new Array(n).join("0") + "0";

				var _arr = decimal.match(/\d/g);
				if(_arr.length <= n){
					//不够，后导补零
					_arr.push(new Array(n-_arr.length).join("0") + n == _arr.length ? "" : "0");
					return int + '.' + _arr.join("");
				}else{
					//够位数，看第n+1位与5的大小
					if(_arr[n] < 5)return int + '.' + _arr.slice(0,n).join("");

					_arr = Number(_arr.slice(0,n).join("")) + 1;

					if(_arr >= Math.pow(10,n)){

						return (int + 1) + '.' + (_arr + '').substring(1);

					}else{
						_arr += '';
						//前导补零
						_arr = new Array(n - _arr.length).join("0") + (n == _arr.length ? '' : '0') + _arr; 
						return int + '.' + _arr;
					}
				}
			}
			return this.toFixed(fen,n)
		},
		// 格式化人民币 0,000,000.00元
		parseRMB: function(str){
			var _this = this;
		    return str.replace(/(\d+)(\d{3})/g,function(a,b,c){
		        var s = b > 100 ? _this.parseRMB(b) : b;
		        _this = null;
				return s + ',' + c;
		    })
		},
		// 规则弹框
		modalRule: function(){
			return this.modalAlign(this.modal.dialog({
				message: $("#rule_tpl").html()
			}).find(".modal-dialog").width("80%"))
		},
		//登录回调操作
		loginCallback : function(cbName){
			if(this.isLogin||this.debug)return "function"== typeof this[cbName]&&this[cbName]();
			if(!this.request.base.client.android && !this.request.base.client.ios){
				var href = global.location.href;
				var page = href.substring(href.indexOf(".com/")+5,href.indexOf(".htm")+4);
				return global.location.href = "https://passport.qbao.com/cas/wapQbaoLogin?service="+encodeURIComponent(Marklbp.request.base.host)+"%2F/index.html";
			}
			global.localStorage.MarklbpLoginCallback = cbName;
			global.loginCallback = function(){
				var cbName = window.localStorage.MarklbpLoginCallback;
				delete window.localStorage.MarklbpLoginCallback;
				Marklbp.isLogin = true;
				"function"== typeof Marklbp[cbName]&&Marklbp[cbName]();
			};
			return this.nativeLogin();
		},
		// loading 等待
		load: function(text){
			text = text || "";
			var $modal = Marklbp.modal.dialog({
				backdrop: "static",
				message: "<img src='//qhb.qbcdn.com/publicFront/img/abs_load_33X33.gif'>\
						  <div class='text-box'>"+text+"</div>",
				closeButton: false,
				className: "modal-load"
			});
			this.modalAlign($modal.find(".modal-dialog"));
			return function(){
				$modal.modal("hide");
			}
		},
		// 支付框
		/**
		 * options = {text:"",isNeedPass:true,isNeedSMS:false}
		*/
        renderModalPay : function(options){
            var tpl = "<form><%if(obj.text){%>\
                        <div class='text clearfix' style='margin-bottom:5px;'><%=text%></div>\
                        <%}%>\
                        <%if(isNeedPass){%>\
                        <div class='form-group' style='margin-bottom: 5px;clear: both;'>\
                            <input type='password' name='password' class='form-control' placeholder='交易密码'>\
                        </div>\
                        <%}%>\
                        <label style='margin-bottom:15px;'>\
                            <input type='checkbox' checked name='isSecretPay' value='1'>\
                            <span><i class='fa fa-check'></i></span>开启免密支付\
                        </label>\
                        <%if(isNeedSMS){%>\
                        <div class='form-group'>\
                            <div class='input-group'>\
                                <input type='text' name='smsCode' class='form-control' placeholder='验证码'>\
                                <div class='input-group-btn'>\
                                    <button type='button' onclick='Marklbp.getSMSCode(this,90,Marklbp.getSMSCodeAjax,false,\"CUT_CAKE_PAY\")' class='btn btn-get-code'>获取验证码</button>\
                                </div>\
                            </div>\
                        </div>\
                        <%}%>\
                        <%if(!isNeedPass&&!isNeedSMS){%>\
                        	<div style='line-height:normal;color:#ed4f47;padding-bottom:15px;'>开启免密支付，无需输入交易密码；<br>免密支付开启后仅限当天有效。</div>\
                        <%}%>\
                        <button type='submit' class='btn btn-block btn-submit<%=isNeedPass||isNeedSMS?\" disabled\":\"\"%>'>确认支付</button></form>"
            var $modalDialog = this.modal.dialog({
                message : this.template(tpl,options),
                className : 'modal-pay'
            })//输入框校验
            .on("input","input[name=password],input[name=smsCode]",function(e){
                Marklbp.validModalPay(e,this,options);
            })
            .on("touchend","[type=submit]",function(){
                $(this.form).submit();
                return false;
            })
            .on("submit","form",function(){
                Marklbp.submitModalPay(this,options)
                return false;               
            })
            .find(".modal-dialog").width("75%");
            this.modalAlign($modalDialog);
            var android = this.request.base.client.android;
			if(android){
				var h = document.documentElement.clientHeight;
				$(global).off().on("resize",function(){
					var _h = document.documentElement.clientHeight;
					if(_h >= h){
						$("input[name=password],input[name=smsCode]").blur();
					}
				})
			}
            return this;
        },
        // 校验支付
        validModalPay: function(e,input,options){
        	/*var android = this.request.base.client.android&&!this.request.base.client.ios;
            if(e.type.toLowerCase().indexOf('focusin')>-1){
                if(android)$(input).parents(".modal-dialog").addClass("fixed-top");
                return;
            }
            if (e.type.toLowerCase().indexOf('focusout')>-1) {
                if(android)return $(input).parents(".modal-dialog").removeClass("fixed-top");
                return;
            }*/

            var $formGroup,$help,
                nextVal = (!options.isNeedPass && "...")||(input.form.password&&$.trim(input.form.password.value)),
                val     = $.trim(input.value),
                tip     = input.name == "password" ? "请输入交易密码":"请输入验证码";

            $formGroup = $(input).parents(".form-group");
            $help = $formGroup.find(".help-block");
            if(val.length <= 0){
                $formGroup.addClass("has-error");
                if($help.length > 0){
                    $help.show();
                }else{
                    $formGroup.append('<span class="help-block"><i class="fa fa-warning"></i>'+tip+'</span>')
                }
                return $(input.form).find("button[type=submit]").addClass("disabled")
            }
            $formGroup.removeClass("has-error");
            $help.hide();
            if(input.name == "password"){
                nextVal = (!options.isNeedSMS && "...")||(input.form.smsCode && $.trim(input.form.smsCode.value));
            }
            if(nextVal.length>0)$(input.form).find("button[type=submit]").removeClass("disabled");
        },
        // 提交支付表单
        submitModalPay: function(form,options){
        	var $submit = $(form).find("button[type=submit]");
            if($submit.hasClass('disabled'))return false;
            $submit.addClass('disabled').text('支付中...');
        	var $modal = $(form).parents(".modal");
        	Marklbp.pay(form,function(status,data){
            	$submit.removeClass("disabled").text("确认支付");
            	if(status){
            		//购买成功
            		$modal.modal("hide");
            		'function' == typeof options.callback && options.callback.call(this,data);
            	}else{
            		//购买失败
            		this.modal.tip(data,1200,true)
            	}
            });
        },
        // 支付
        pay: function(form,callback){
        	var inputs = $(form).serializeArray();
        	var param = {};
        	for (var i = 0; i < inputs.length; i++) {
        		param[inputs[i].name] = inputs[i].value
        	}
        	return this.ajax($.extend(true,{},this.request.play,{
        		dataType: "json",
        		param: param,
        		timeout: 20000,
        		done: function(data){
        			this.modal.tip("支付成功",{
        				time: 1200,
        				callback: function(){
	        				"function" == typeof callback && callback.call(Marklbp,true,data)
	        			}
        			},true);
        		},
        		fail: function(data){
					if(data.code == -9)return $(form).parents(".modal").modal('hide'),this.modal.tip(data.value,{
						time: 1200,
						callback: function(){
							Marklbp.isLogin = false;
							Marklbp.loginCallback("playEvt");
						}
					},true)
        			return 'function'== typeof callback&&callback.call(this,false,data.value)
        		}
        	}))
        },
        modal:{
        	tip : function(message,close,isCenter){
                var time     = 3000;
                var effect   = 'fadeOut';
                var callback = function(){};
                var modal = this.dialog({
                     message : message,
                     closeButton : false,
                     backdrop : false
                }).addClass("modal-tip");
                var modalDialog = modal.removeClass("fade").find(".modal-dialog");
                if(isCenter)Marklbp.modalAlign(modalDialog);
                if('number' == typeof close){
                    time = close;
                }else if('object' == typeof close){
                    time     = 'number' == typeof close.time ? close.time : 3000;
                    callback = 'function' == typeof close.callback ? close.callback : callback
                }else if('function' == typeof close){
                    callback = close;
                }
                setTimeout(function(){
                     modal[effect](800,function(){
                       $(document.body).removeClass("modal-open");
                       $(this).remove();
                       callback();
                     })
                },time);
                return modal;
            }
       	},
       	//缓存接口请求
		request : {
			getSMSCode: {
				url : "/sms/sendVerifyCode2",
				debug : "getSMSCode.json",
				type : "get",
				param : {
					//smsMsg : "PAY_BUY_TREASURE_BOX" //GGL_BUY 验证码类型
				}//,
				//_data : ""
			},
			//切换楼宇弹出广告接口
			tabAd : { 
				url    : "/banner/ajax/loadBannerList/countDown.html"
				,debug : "tabAd.json"
				,param : false
				/*,_data  : {
					
					bannerList : [
						{
							id : 0,
							title : "", //广告标题
							imgUrl : "", //广告图片地址
							link : "" //广告链接
						}
					],
					intervalMilliseconds : 3000 //轮播切换时间
				}*/
			},
			getPayCfg: {
				url: "/building/config.html"
				,debug: "playBatch.json"
				,param: false
				/*,_data: {
					"isNeedPass":true,
					"isNeedSMS":true
				}*/
			},
			getBBS: {
				url: "/play/config.html"
				,debug: "playBatch.json"
				,param: false
				/*
				_data: {
					"advertSwitch":1,//消息轮播开关，1-打开，0-关闭
					"rewardPlayConfig":[
						{"username":"U_1******31","reward":888,"floorIndex":100,"message":"U_1******31抢到100层，获得8.88元"},
						{"username":"U_1******31","reward":888,"floorIndex":100,"message":"U_1******31抢到100层，获得8.88元"},
						{"username":"U_1******31","reward":888,"floorIndex":100,"message":"U_1******31抢到100层，获得8.88元"},
						{"username":"U_1******31","reward":888,"floorIndex":100,"message":"U_1******31抢到100层，获得8.88元"},
						{"username":"U_1******31","reward":888,"floorIndex":100,"message":"U_1******31抢到100层，获得8.88元"}
					],
					"advertInfo":"我是一个跑马灯"
				}
				*/
			},
			//楼宇加载接口
			loadBuildings : {
				//url : "/building/loadBuildings.html"
				url: "/building/loadBuildings2.html"
				,debug : "loadBuildings.json"
				,param : false
				/*,_data : {				
					"totalRaffleCount": 0,
					"hasUserRaffleBefore": true,
					"balance": 100000,
					"needSms": true,
					"futureBuilding": null,
					"waitCoupon": 0,
					"isUserLogin": true,
					"buildingReward": 0,					
					"raffleIndex": {
						"id": null,
						"buildingId": null,
						"floorCount": 1000,
						"buildingIndex": 1,
						"breakTime": null,
						"buildingStatus": "RAFFING"
					},
					"raffledBuilding": {
						"id": 0,
						"name": "新版大楼",
						"buildingIndex": 1,
						"floorCount": 1000,
						"showSmallReward": false,
						"bigFloors": [{
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						}, {
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						}, {
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						}, {
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						}],
						"finalFloor": {
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						},
						"bigBuilding": false
					},
					"currentBuilding": {
						"id": 0,
						"name": "新版大楼",
						"buildingIndex": 1,
						"floorCount": 1000,
						"showSmallReward": false,
						"bigFloors": [{
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						}, {
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						}, {
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						}, {
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						}],
						"finalFloor": {
							"floorIndex": 10,
							"reward": 100,
							"coupon": 0
						},
						"bigBuilding": false
					},
				}*/
			},
			//批量抢 raffleCount > 1的时候结果从batchRaffle中取，raffleCount = 1的时候结果从raffleRecord中取
			play : {
				url : '/ajax/batchRaffle2.html'//'/ajax/batchRaffle.html'
				,debug : 'playBatch.json'
				,param : {
					raffleCount: 0
				}
				/*,_data : {
					
					"balance": 0,
					"buildingReward": 0,
					"batchRaffle": {
						"id": 0,
						"userId": 0,
						"totalRewards": 1000,
						"bigRewardsCount": null,
						"raffleCount": 0,
						"status": null,
						"beginTime": null,
						"finishTime": null
					},
					"raffleRecord": {
						"id": 0,
						"userId": 0,
						"buildingIndex": 1,
						"floorIndex": 5,
						"reward": 100,
						"groupId": null,
						"groupName": null,
						"type": null,
						"mode": null,
						"raffleTime": null,
						"batchRaffleId": null,
						"coupon": 0,
						"rewardType": "QB",
						"formatedRaffleTime": "",
						"groupMode": false,
						"personalMode": false
					},
					"wallet": {
						"raffleCount": 0,
						"totalReward": 0,
						"waitReward": 0,
						"totalCoupon": 0,
						"waitCoupon": 0,
						"totalRaffleCount": 0,
						"waitRaffleCount": 0
					},
					"raffledCount": 0,
					"totalCount": 0
				}*/
			},
			//刷新大楼状态
			refreshBuilding : {
				url : '/ajax/refreshBuilding2.html'
				,debug : 'refreshBuilding.json'
				,param : false
				/*,_data : {
					raffleIndex : {
						buildingId : 0,
						buildingIndex : 0,
						floorIndex : 0,
						buildingStatus : '',
						leftBreakTime : 0
					}
				}*/
			},
			//获取中奖纪录
			getRewardRecord : {
				url : '/ajax/listRaffleRecord2/{buildingIndex}/{iDisplayStart}.html'//'/ajax/listRaffleRecord/{buildingIndex}/{iDisplayStart}.html'
				,debug : 'getRewardRecord.json'
				,param : {
					buildingIndex : 0, //大楼编号
					iDisplayStart : 0 //显示开始索引
				}
				/*,_data : {
					domain : '',
					aaData : [
						{
							username : "",			//用户名
							type : "",
							buildingIndex : 0,
							floorIndex : 0,		//抢到楼层的层数
							reward : 0,
							groupName : '',
							mode : '',
							raffleTime : '',	//中奖时间
							userId : 0,
							groupId : '',
							coupon : 56,  //抢到的宝券数
							modeName : '',
							groupMode : false
						}
					],
					"itotalDisplayRecords" : 0,				
					"itotalRecords" : 27,	//总记录条数
					"secho" : "1"
				}*/
			} 
		}
	});
	var subfix = context.request.base.subfix;
	for(var att in context.request){
		if("url" in context.request[att]){
			context.request[att].type = context.debug ? "get" : (context.request[att].type || "post");
			if(context.debug){context.request[att].url = context.request[att].debug;continue;}
			if(context.request[att].url.indexOf(subfix)>0)continue;
			context.request[att].url = context.request[att].url + subfix;
		}
	};
}(this,Marklbp)
+function(global,context){
	return $.extend(true,context,{
		//重写初始化
		init : function(){
			//debug模式
			this.listRewardInit().initEvents(this.initEventsCallback);
		}
		,parseTime: function(time){
			if(isNaN(time))time = $.now();
			var date = new Date(time);
			var m = date.getMonth() + 1;
			var d = date.getDate();
			var h = date.getHours();
			var f = date.getMinutes();
			var s = date.getSeconds();
			return (m > 9 ? m : '0' + m) + '-' + (d > 9 ? d : '0' + d) + ' ' + (h > 9 ? h : '0' + h) + ':' + (f > 9 ? f : '0' + f) + ':' + (s > 9 ? s : '0' + s);
		}
		//初始化页面事件
		,initEventsCallback : function(){
			if(this.initEventsCallback.inited)return;
			this.initEventsCallback.inited = true;
			var that       = this;
			var touchstart = "mousedown";
			var touchmove  = "mousemove";
			var touchend   = "click";
			if("ontouchstart" in document){
				touchstart = "touchstart";
				touchmove  = "touchmove";
				touchend   = "touchend";
			}
			//滚动加载
			var callback   = function(){

				var maxScrollTop = $(this).find(".list").height() - $(this).height();
				var scrollTop    = $(this).scrollTop();
				$(this).find(".red.col-xs-6.text-right").html(that.isScrollAjax+','+scrollTop+','+maxScrollTop);
				if(that.isScrollAjax == "over" || that.getRewardRecorded || (that.pagination && that.paginationstart))return;
				if(!that.isScrollAjax&&Math.abs(maxScrollTop - scrollTop) <= 3){
					that.isScrollAjax  = true;
					that.iDisplayStart += 10;
					if(that.pagination && that.iDisplayStart / 10 > 5){
						that.paginationstart = true;
						$(".list").css("padding-bottom","5.75rem");
					}
					that.getRewardRecord(function(){
						//加载完后重置滚动请求标识
						this.isScrollAjax = false;
					});
				}
			};
			$(document)
			//滚动加载
			.on("touchmove mouseover",".page",function(e){
				$(this).off().on("scroll",callback);
				callback.apply(this,e);
			})
			//记录分页
			.on(touchend,".first-page,.prev-page,.next-page,.last-page",function(){
				var hasClassName = this.className;
				var iDisplayStart = 0;
				if(hasClassName.indexOf("first-page") > -1){
					iDisplayStart = 0;
				}else if(hasClassName.indexOf('last-page') > -1){
					iDisplayStart = (that.pageSum - 1) * 10;
				}else if(hasClassName.indexOf('prev-page') > -1){
					iDisplayStart = (that.iDisplayStart / 10 - 1) * 10;
					iDisplayStart = iDisplayStart < 0 ? 0 : iDisplayStart;
				}else{
					iDisplayStart = (that.iDisplayStart / 10 + 1) * 10
				}
				if(iDisplayStart == that.iDisplayStart)return;
				//允许翻页的标识
				that.iDisplayStart = iDisplayStart;
				that.getRewardRecord();
			})
			.on("change",".go-page select",function(){
				var val = parseInt(this.value);
				if(val == that.iDisplayStart / 10 + 1)return;
				that.iDisplayStart = (val - 1) * 10;
				that.getRewardRecord();
			});
			return this;
		}
		//获奖记录初始化
		,listRewardInit : function(callback){
            var flatData = {
                buildingIndex : parseFloat(localStorage.buildingIndex) || 0,
                buildingName  : localStorage.buildingName || ''
            };
			this.buildingIndex = flatData.buildingIndex;
			this.iDisplayStart = 0;
			var html = $("#flat-tpl").html();
			//初始化大楼编号和大楼名称
			$(this.template(html,flatData)).fadeIn(100).prependTo($('.page'));
			//加载记录
			this.iDisplayCount = 0;
			this.getRewardRecord();
			return this;
		}
		//获奖记录
		,getRewardRecord : function(callback){
			var url   = this.request.getRewardRecord.url;
			var param = $.extend(this.request.getRewardRecord.param,{
				buildingIndex : this.buildingIndex,
				iDisplayStart : this.iDisplayStart
			});
			if(this.iDisplayStart > this.pageSum * 10 - 10)return;
			if(!this.debug){
				url = url.replace(/{([^}]+)}/g,function(a,b){
					return param[b];
				})
			}
			$(".loading").removeClass("text").text("加载中...").show();
			setTimeout($.proxy(function(){
				this.ajax($.extend(true,{},this.request.getRewardRecord,{
					url  : url,
					dataType: 'json',
					always : function(){
						return 'function' == typeof callback && callback.apply(this);
					},
					done : function(data){
						$(".loading").hide();
						this.pageSum = Math.ceil(data.itotalDisplayRecords / 10 );
						if(data.itotalDisplayRecords / 10 >10){
							this.pagination = true;
						}else{
							if($(".list .row").length == data.itotalDisplayRecords ){
								this.getRewardRecorded = true;
							}
						}
						
						this.iDisplayCount += data.aaData.length;
						var html = this.template($("#data-tpl").html(),data);
						if(!this.paginationstart){
							$(".loading").before($(html));
						}else{
							$(".page").off();
							$(".loading").siblings(".row").remove().end().before($(html));
						}
					},
					fail : function(data){
						if(data.code == -9)return this.modal.tip(data.value,{
							time: 1200,
							callback: function(){
								Marklbp.isLogin = false;
								Marklbp.loginCallback("getRewardRecord")
							}
						},true)
						$(".loading").addClass('text').text(data.value);
					}
				}))				
			},this),750)
			return this;
		}
		
	})[context.debug ? 'init':'checkLogin']();
}(window,Marklbp)